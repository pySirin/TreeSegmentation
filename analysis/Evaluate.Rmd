---
title: "Evaluate tree crown segmentation algorithms using Lidar"
author: "Ben Weinstein"
date: "4/20/2018"
output: 
  html_document:
    toc: true
    number_sections: true
---

```{r,warning=F,message=F}
library(dplyr)
library(knitr)
library(maptools)
library(TreeSegmentation)
library(ggplot2)
library(rgl)
library(clue)
library(lidR)
knit_hooks$set(webgl = hook_webgl)
opts_chunk$set(warning=F,message=F)

#set color ramp for treeID
col = pastel.colors(200)

```

# Load in ground-truth
```{r}
shps<-list.files("/Users/ben/Dropbox/Weecology/ECODSEdataset/Task1/ITC/",pattern=".shp",full.names = T)
itcs<-lapply(shps,readShapePoly)

names(itcs)<-sapply(itcs,function(x){
  id<-unique(x$Plot_ID)
  })

itcs<-lapply(itcs,function(x){
  proj4string(x)<-CRS("+init=epsg:32617")
  return(x)
})
```
# Example Pipeline

## Read in Data
```{r,webgl=TRUE}
ground_truth<-itcs[[20]]
fname<-get_tile_filname(ground_truth)
tile<-readLAS(paste("/Users/ben/Dropbox/Weecology/NEON/cropped_",fname,sep=""))
tile@crs<-CRS("+init=epsg:32617")
plot(tile)
```

## Compute Segmentation

```{r}
silva<-silva2016(tile=tile,extra=T)
dalponte<-dalponte2016(tile=tile,extra=T)
```

## View 3d segmentation
```{r,webgl=TRUE}
plot(silva$tile,color="treeID",col=col)
```

### Overlay ground truth and predictions

```{r}
plot(ground_truth,col='red')
plot(silva$convex,add=T)
```

### CHM versus predicted polygons

```{r}
chm=canopy_model(silva$tile)
plot(chm,ext=extent(ground_truth))
plot(ground_truth,add=T,col='red')
plot(silva$convex,add=T)
```

Okay that's not great, but let's keep going for the moment.

### Compare Methods

```{r}
plot(silva$convex,col="blue")
plot(dalponte$convex,add=T)
```

## Assign Trees

Each tree is assigned based on the maximum overlap. Pairwise membership is done using a Hungarian Algorithm. See clue::solve_LSAP.

```{r}
assignment<-assign_trees(ground_truth,prediction=silva$convex)
```

## Calculate Intersection over union

```{r}
#loop through assignments and get jaccard statistic for each assignment pair
statdf<-calc_jaccard(assignment=assignment,ground_truth = ground_truth,prediction=silva$convex)
ggplot(statdf) + geom_histogram(aes(IoU)) + labs(x="Intersection over union") + theme_bw()
mean(statdf$IoU)
median(statdf$IoU)
```

# As a wrapper for one tile, multiple methods
```{r}
results<-evaluate(ground_truth=itcs[[5]],algorithm = c("silva","dalponte","li"),path_to_tiles="/Users/ben/Dropbox/Weecology/NEON/cropped_")
ggplot(results,aes(x=IoU,fill=Method)) + geom_histogram(position = position_dodge()) + theme_bw()
```

#Wrapper across all tiles

```{r,eval=F}
system.time(silvadf<-evaluate_all(itcs=itcs,algorithm = "silva",path_to_tiles="/Users/ben/Dropbox/Weecology/NEON/cropped_"))
qplot(silvadf$IoU)
mean(silvadf$IoU)
```
