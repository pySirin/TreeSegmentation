---
title: "Evaluate Tree Crown Method Based on Segmentation Algorithms"
author: "Ben Weinstein"
date: "4/20/2018"
output: html_document
---

```{r,warning=F,message=F}
library(dplyr)
library(knitr)
library(maptools)
library(TreeSegmentation)
library(ggplot2)
library(rgl)
library(clue)
library(lidR)
knit_hooks$set(webgl = hook_webgl)

opts_chunk$set(warning=F,message=F)

#set color ramp for treeID
col = pastel.colors(200)

```

# Load in ground-truth
```{r}
shps<-list.files("/Users/ben/Dropbox/Weecology/ECODSEdataset/Task1/ITC/",pattern=".shp",full.names = T)
itcs<-lapply(shps,readShapePoly)
itcs[[1]]

names(itcs)<-sapply(itcs,function(x){
  id<-unique(x$Plot_ID)
  })
print(names(itcs))
plot(ground_truth<-itcs[[1]])
itcs[[1]]
#proj_itc <-spTransform(itc, CRS("+init=epsg:32617"))

```
# Find corresponding tile

```{r,webgl=TRUE}
fname<-get_tile_filname(itcs[[1]])
tile<-readLAS(paste("/Users/ben/Dropbox/Weecology/NEON/cropped_",fname,sep=""))
plot(tile)
```

# Silva 2016 Crown Segmentation Model

```{r,webgl=TRUE}
silva<-silva2016(tile=tile,extra=T)
```

#Overlay ground truth and predictions

```{r}
plot(ground_truth,col='red')
plot(silva$silva_convex,add=T)
```

Classified lidar cloud versus predicted polygons

```{r}
plot(silva$silva_tile,color="treeID",col=col,size=2)
show2d(face='z+',z=0,{
  plot(silva$silva_convex,col=rgb(255, 0, 0, 30, maxColorValue=255) )
})
```


Classified lidar cloud versus ground_truth

```{r,webgl=TRUE}
plot(silva$silva_tile,color="treeID",col=col)
show2d(face='z+',z=0,{
  plot(ground_truth,col=rgb(255, 0, 0, 30, maxColorValue=255) )
})
```

# Assign Trees

Each tree is assigned based on the maximum overlap. Pairwise membership is done using a Hungarian Algorithm. See clue::solve_LSAP.

```{r}
assignment<-assign_trees(ground_truth,prediction=silva$silva_convex)
```

# Intersection over union

```{r}
#loop through assignments and get jaccard statistic for each assignment pair
statdf<-calc_jaccard(assignment=assignment,ground_truth = ground_truth,prediction=silva$silva_convex)
qplot(statdf$IoU)
mean(statdf$IoU)
median(statdf$IoU)
```
