---
title: "Evaluate Tree Crown Method Based on Segmentation Algorithms"
author: "Ben Weinstein"
date: "4/20/2018"
output: html_document
---

```{r}
library(dplyr)
library(knitr)
library(maptools)
library(TreeSegmentation)
library(ggplot2)
library(rgl)
library(clue)

#set color ramp for treeID
col = pastel.colors(200)

```

# Load in ground-truth
```{r}
shps<-list.files("/Users/ben/Dropbox/Weecology/ECODSEdataset/Task1/ITC/",pattern=".shp",full.names = T)
itcs<-lapply(shps,readShapePoly)

names(itcs)<-sapply(itcs,function(x){
  id<-unique(x$Plot_ID)
  })
print(names(itcs))
plot(ground_truth<-itcs[[1]])
```
# Find corresponding tile

```{r,webgl=TRUE}
tile<-readLAS("/Users/ben/Dropbox/Weecology/NEON/cropped_NEON_D03_OSBS_DP1_402000_3286000_classified_point_cloud.laz")
plot(tile)
```

# Silva 2016 Crown Segmentation Model

```{r}
silva<-silva2016(tile=tile,extra=T)
```

#Overlay ground truth and predictions

```{r}
plot(ground_truth,col='red')
plot(silva$silva_convex,add=T)
```

Classified lidar cloud versus predicted polygons

```{r}
plot(silva$silva_tile,color="treeID",col=col,size=2)
show2d(face='z+',z=0,{
  plot(silva$silva_convex,col=rgb(255, 0, 0, 30, maxColorValue=255) )
})
```


Classified lidar cloud versus ground_truth

```{r}
plot(silva$silva_tile,color="treeID",col=col)
show2d(face='z+',z=0,{
  plot(ground_truth,col=rgb(255, 0, 0, 30, maxColorValue=255) )
})
```

# Assign Trees

Each tree is assigned based on the maximum overlap. Pairwise membership is done using a Hungarian Algorithm. See clue::solve_LSAP.

# Intersection over union

```{r}

assignment<-assign_trees(ground_truth,prediction)

IoU<-function(ground_truth,prediction){
  #Find overlap among all pairs
  for(x in 1:nrow(ground_truth)){
    pol<-ground_truth[x,]
    
    #Find all overlapping polygons
    
    
  }
  area(raster::intersect(ground_truth,prediction))
  
  
}



```
