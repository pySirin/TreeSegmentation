---
title: "Neon Recall"
author: "Ben Weinstein"
date: "4/20/2018"
output: 
  html_document:
    toc: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r,warning=F,message=F}
library(tidyverse)
library(knitr)
library(maptools)
library(rgdal)
library(TreeSegmentation)
library(sp)
library(rgl)
library(lidR)
library(kableExtra)

knit_hooks$set(webgl = hook_webgl)
opts_chunk$set(warning=F,message=F)

#set color ramp for treeID
col = pastel.colors(200)

site="SJER"

#set data paths
path_to_tiles=paste("../data/NeonPlots/",site,"/Lidar/",sep="")
basemap=paste("../data/NeonPlots/",site,"/Camera/L3/",sep="")

#set cores
cores<-2
#cores<-15
```

# Load in ground-truth
```{r,results='hide'}
dat<-read.csv("../data/Terrestrial/field_data.csv")

sites<-dat %>% filter(siteID==site) %>% droplevels()

#accepted species list
species<-read.csv("../data/NEONPlots/AcceptedSpecies.csv")
species<-species %>% filter(siteID %in% sites$siteID)

#filter data by species
sites <- sites %>% filter(scientificName %in% species$scientificName)

#search for duplicates, ending in a letter
sites<-sites %>% filter(!is.na(as.numeric(str_sub(individualID,-1))))

#Individual trees
trees<-sites  %>% filter(!is.na(UTM_E))

#get tiles to evaluate, match with deep learning 
rgb_tiles<-list.files(paste("/Users/Ben/Documents/DeepForest/data/",site,sep=""))
plotIDs<-str_match(rgb_tiles,"(SJER_\\d+).tif")[,2]
plotIDs<-plotIDs[!is.na(plotIDs)]

recalls=list()
  for(x in 1:length(plotIDs)){
    recalls[[x]]<-evaluateNeon(trees=trees,plotID=plotIDs[x],path_to_tiles=path_to_tiles,algorithm = "silva",basemap = basemap,proj4="+init=epsg:32611",plot_results=T)
  }

#remove empty rows
print(sum(unlist(recalls))/length(unlist(recalls)))

```

